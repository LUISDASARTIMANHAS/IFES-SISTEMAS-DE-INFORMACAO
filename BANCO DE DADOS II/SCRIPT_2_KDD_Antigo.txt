-- CRIAÇÃO DE TABELAS (COM CARGA DE REGISTROS)

CREATE TABLE PRODUTO (
   ID_PRODUTO SERIAL NOT NULL PRIMARY KEY,
   NOME VARCHAR(30) NOT NULL,
   ESTOQUE INTEGER NOT NULL,
   PRECO NUMERIC(9,2) NOT NULL	
);

INSERT INTO PRODUTO (NOME, ESTOQUE, PRECO) 
VALUES ('LEITE',100,5.08), ('PÃO',300,1.11),('BOLACHA',50,3.99),('SUCO',200,9.19),
       ('CAFÉ',100,3.39),('OVOS',400,11.45);
	   
SELECT * FROM PRODUTO;	   

CREATE TABLE VENDA (
   NR_VENDA SERIAL NOT NULL PRIMARY KEY,
   DATA_VENDA DATE NOT NULL	
);

INSERT INTO VENDA (DATA_VENDA) VALUES ('2021-07-21'),('2021-09-22'),('2021-12-24'),('2022-01-25');

SELECT * FROM VENDA;

CREATE TABLE ITEM_VENDIDO (
   NR_VENDA INTEGER NOT NULL,
   ID_PRODUTO INTEGER NOT NULL,
   QUANTIDADE INTEGER NOT NULL,

	PRIMARY KEY(NR_VENDA, ID_PRODUTO),
	
	FOREIGN KEY (NR_VENDA) REFERENCES VENDA (NR_VENDA) ON DELETE RESTRICT,
	FOREIGN KEY (ID_PRODUTO) REFERENCES PRODUTO (ID_PRODUTO) ON DELETE RESTRICT
);

INSERT INTO ITEM_VENDIDO VALUES(1,1,5),(1,2,10),(1,3,3),(1,4,1),(2,1,10),(2,4,1),(3,1,10),(3,6,10),
                               (4,2,5),(4,3,6),(4,5,2); 

SELECT NR_VENDA, P.ID_PRODUTO, NOME, QUANTIDADE, PRECO
FROM PRODUTO P, ITEM_VENDIDO I
WHERE P.ID_PRODUTO = I.ID_PRODUTO
ORDER BY NR_VENDA, P.ID_PRODUTO;

-- FUNÇÃO QUE BUSCA TODOS OS ITENS VENDIDOS E OS DEVOLVE A PARTIR DE UM CURSOR.

CREATE OR REPLACE FUNCTION CONSULTA_ITENS(REFCURSOR) RETURNS REFCURSOR AS $$
BEGIN
   OPEN $1 FOR SELECT * FROM ITEM_VENDIDO ORDER BY NR_VENDA, ID_PRODUTO;
   RETURN $1;
END;
$$ LANGUAGE PLPGSQL;

BEGIN;
   SELECT CONSULTA_ITENS('query1');
   
   FETCH ALL IN query1;
   
COMMIT;

-- CRIAÇÃO DE TABELA TEMPORÁRIA

CREATE TEMPORARY TABLE ITEM (
   NR_VENDA INTEGER NOT NULL PRIMARY KEY,
   LEITE BOOLEAN NOT NULL,
   PAO BOOLEAN NOT NULL,
   BOLACHA BOOLEAN NOT NULL,
   SUCO BOOLEAN NOT NULL,
   CAFE BOOLEAN NOT NULL,
   OVOS BOOLEAN NOT NULL
);
-- fUNÇÃO ---------------------------------------------------------------------------+
CREATE OR REPLACE FUNCTION CARGA_ITEM_TEMPORARIO(REFCURSOR) RETURNS REFCURSOR AS $$
DECLARE
   
   R ITEM_VENDIDO%ROWTYPE;
   NUM INTEGER;
   ANTERIOR INTEGER;
   PAO BOOLEAN;
   LEITE BOOLEAN;
   BOLACHA BOOLEAN;
   SUCO BOOLEAN;
   CAFE BOOLEAN;
   OVOS BOOLEAN;

BEGIN
   DROP TABLE IF EXISTS ITEM;
   
   CREATE TABLE ITEM (
      NR_VENDA INTEGER NOT NULL PRIMARY KEY,
      LEITE BOOLEAN NOT NULL,
      PAO BOOLEAN NOT NULL,
      BOLACHA BOOLEAN NOT NULL,
      SUCO BOOLEAN NOT NULL,
      CAFE BOOLEAN NOT NULL,
      OVOS BOOLEAN NOT NULL
   );

   ANTERIOR:= -1;
   
   
   FOR R IN SELECT NR_VENDA, ID_PRODUTO FROM ITEM_VENDIDO ORDER BY NR_VENDA
   LOOP
      IF R.NR_VENDA <> ANTERIOR THEN 
        IF ANTERIOR <> -1 THEN
	       INSERT INTO ITEM	VALUES (anterior, LEITE, PAO, BOLACHA, SUCO, 
								    CAFE, OVOS);
        END IF;
		
        LEITE:= FALSE;
        PAO:= FALSE;
        BOLACHA:= FALSE;
        SUCO:= FALSE; 
        CAFE:= FALSE;
        OVOS:= FALSE;
        ANTERIOR := R.NR_VENDA;
     END IF;
	  
      IF R.ID_PRODUTO = 1 THEN LEITE := TRUE; END IF;
      IF R.ID_PRODUTO = 2 THEN PAO := TRUE; END IF;
      IF R.ID_PRODUTO = 3 THEN BOLACHA := TRUE; END IF;
      IF R.ID_PRODUTO = 4 THEN SUCO := TRUE; END IF;
      IF R.ID_PRODUTO = 5 THEN CAFE := TRUE; END IF;
      IF R.ID_PRODUTO = 6 THEN OVOS := TRUE; END IF;
   END LOOP;

   INSERT INTO ITEM	VALUES (anterior, LEITE, PAO, BOLACHA, SUCO, 
						    CAFE, OVOS);
							
   OPEN $1 FOR SELECT * FROM ITEM ORDER BY NR_VENDA;
   RETURN $1;
END;
$$ LANGUAGE PLPGSQL;
-- Fim da Função -------------------------------------------------------------------------------------+

BEGIN; -- INÍCIO DA TRANSAÇÃO

   SELECT CARGA_ITEM_TEMPORARIO('meucursor'); -- EXECUÇÃO DA FUNÇÃO

   FETCH ALL IN meucursor; -- EXIBINDO TODOS OS DADOS DE CURSOR RETORNADO PELA FUNÇÃO

COMMIT; -- FIM DA TRANSAÇÃO


SELECT * FROM ITEM;  